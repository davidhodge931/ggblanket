---
title: "Go further"
author: "David Hodge"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  warning = FALSE,
  fig.width = 6,
  fig.asp = 0.618,
  out.width = "70%",
  dpi = 300
  )
```

## Overview

This article will demonstrate more advanced content, including how to: 

1. Use different fonts
2. Visualise spatial data
3. Turn off either colour or fill
4. Fix either colour or fill to something different 
5. Work with other aesthetics (or delayed evaluation)
6. Change the stat
7. Create custom wrapper functions
8. Add contrasting dark or light text on polygons
9. Use the gg_blanket function for other geoms


```{r setup}
library(dplyr)
library(stringr)
library(ggplot2)
library(ggblanket)
library(patchwork)

penguins2 <- palmerpenguins::penguins |>
  mutate(sex = stringr::str_to_sentence(sex)) |>
  tidyr::drop_na(sex)
```

### 1. Use different fonts

The showtext and sysfonts packages support the use of different fonts from Google. The `*_mode` theme functions provide `base_family`, `title_family`, `subtitle_family` and `caption_family` arguments. Fonts can be identified on the Google fonts [website](https://fonts.google.com/).

```{r, fig.asp = 0.75, fig.showtext = TRUE}
sysfonts::font_add_google("Covered By Your Grace", "grace")
sysfonts::font_add_google('Roboto Slab', 'roboto_slab')
sysfonts::font_add_google('Syne Mono', 'syne')

showtext::showtext_auto(enable = TRUE)

penguins2 |>
  gg_point(
    x = flipper_length_mm,
    y = body_mass_g,
    col = sex,
    facet = species,
    title = "Penguins body mass by flipper length",
    subtitle = "Palmer Archipelago, Antarctica",
    caption = "Source: Gorman, 2020",
    theme = light_mode_rt(
      base_size = 11,
      base_family = "grace", 
      title_family = "roboto_slab", 
      subtitle_family = "syne"))
showtext::showtext_auto(enable = FALSE)
```

### 2. Visualise spatial data

As ggblanket wraps the `ggplot2::geom_sf` and `ggplot2::geom_raster` functions, spatial vector and array data can be visualised. 

```{r, fig.asp=0.33}
sf::st_read(system.file("shape/nc.shp", package = "sf"), 
            quiet = TRUE) |>
  gg_sf(col = AREA) +
  ggeasy::easy_remove_axes()
```

```{r}
stars::read_stars(system.file("tif/L7_ETMs.tif", package = "stars")) |>
 tibble::as_tibble() |>
 gg_raster(x = x,
           y = y,
           col = L7_ETMs.tif,
           facet = band,
           col_title = "L7 ETMs"
           ) +
  ggeasy::easy_remove_axes()
```

### 3. Turn off either colour or fill 

Users can turn off _either_ the colour (i.e. of the outlines) or fill of a geom that contains both. 

The recommended approach is to use `colour = NA` or `fill = NA`, and add in a col aesthetic if you don't already have one (as well as removing the legend).

```{r, fig.asp=1}
p1 <- iris |>
  gg_density(
    x = Sepal.Length,
    col = Species,
    fill = NA, 
    y_labels = \(x) str_keep_seq(x, drop0trailing = TRUE),
    col_labels = \(x) str_to_sentence(x),
    title = "Turn off either colour or fill"
  )

p2 <- iris |>
  gg_density(
    x = Sepal.Length, 
    col = Species,
    colour = NA, 
    y_labels = \(x) str_keep_seq(x, drop0trailing = TRUE),
    col_labels = \(x) str_to_sentence(x))

p3 <- iris |>
  mutate(hack = "") |> 
  gg_density(
    x = Sepal.Length,
    col = hack, 
    fill = NA, 
    y_labels = \(x) str_keep_seq(x, drop0trailing = TRUE)) +
  guides(colour = "none", fill = "none")

p4 <- iris |>
  mutate(hack = "") |> 
  gg_density(
    x = Sepal.Length,
    col = hack, 
    colour = NA, 
    y_labels = \(x) str_keep_seq(x, drop0trailing = TRUE)) +
  guides(colour = "none", fill = "none")

p1 
p2
p3
p4
# (p1 + p2) / (p3 + p4) 
```

### 4. Fix either colour or fill to something different 

Users can also fix _either_ the colour (i.e. of the outlines) or fill of a geom to something different than the `col_pal`. 

The recommended approach is to use `colour = "orange"` or `fill = "orange"`, and add in a `col` aesthetic if you don't already have one (as well as removing the legend).

```{r, fig.asp=1}
p1 <- iris |>
  gg_density(
    x = Sepal.Length,
    col = Species,
    fill = "orange", 
    y_labels = \(x) str_keep_seq(x, drop0trailing = TRUE),
    col_labels = \(x) str_to_sentence(x),
    title = "Fix a different colour or fill"
  )

p2 <- iris |>
  gg_density(
    x = Sepal.Length, 
    col = Species,
    colour = "orange", 
    y_labels = \(x) str_keep_seq(x, drop0trailing = TRUE),
    col_labels = \(x) str_to_sentence(x))

p3 <- iris |>
  mutate(hack = "") |> 
  gg_density(
    x = Sepal.Length,
    col = hack, 
    fill = "orange", 
    y_labels = \(x) str_keep_seq(x, drop0trailing = TRUE)) +
  guides(colour = "none", fill = "none")

p4 <- iris |>
  mutate(hack = "") |> 
  gg_density(
    x = Sepal.Length,
    col = hack, 
    colour = "orange", 
    y_labels = \(x) str_keep_seq(x, drop0trailing = TRUE)) +
  guides(colour = "none", fill = "none")

p1 
p2
p3
p4

# (p1 + p2) / (p3 + p4) 
```

### 5. Work with other aesthetics (or delayed evaluation)

Most functions have the commonly needed aesthetics directly available as an argument.

For those that are not available - or where you wish to use delayed evaluation -, you can either use `mapping` argument.

The `mapping` argument provides access to the `linetype`, `shape` and `size` aesthetics within the `gg_*` function. Note the `col`, `colour`, `fill` and `alpha` aesthetics cannot be added within the ggblanket `mapping` argument. 

```{r}
penguins2 |> 
  gg_point(x = flipper_length_mm, 
           y = body_mass_g, 
           col = species,
           mapping = aes(shape = species))
```

```{r, fig.asp=0.55}
penguins2 |>
  gg_histogram(x = flipper_length_mm,
               mapping = aes(y = after_stat(density)),
               facet = species)
```

```{r, fig.asp=0.55}
faithfuld |>
  gg_contour(
    x = waiting,
    y = eruptions,
    z = density,
    mapping = aes(colour = after_stat(level)),
    bins = 8)
```

### 6. Change the stat

The default `stat` of each `gg_*` function can be changed for additional flexibility. 

```{r, fig.asp=0.7}
p1 <- penguins2 |>
  gg_pointrange(
    x = species,
    y = flipper_length_mm, 
    stat = "summary", 
    size = 0.1,
    x_labels = \(x) str_sub(x, 1, 1))

p2 <- penguins2 |>
  gg_bar(x = flipper_length_mm,
         stat = "bin", 
         x_labels = \(x) str_keep_seq(x))

p3 <- penguins2 |>
  gg_bar(
    x = flipper_length_mm,
    y = species,
    col = sex,
    stat = "summary", 
    position = ggplot2::position_dodge(),
    width = 0.75)

p1
p2
p3
# (p1 + p2) / p3
```

### 7. Create custom wrapper functions

You can create powerful custom functions. This is because the `...` argument can allow you to access _all_  arguments within the ggblanket `gg_*` function (and applicable `ggplot2::geom_*` function). 

```{r, fig.asp=1}
gg_point_custom <- function(data, x, y, col = NULL, facet = NULL, facet2 = NULL,
                            col_pal = RColorBrewer::brewer.pal(8, "Dark2"),
                            col_labels = \(x) stringr::str_to_sentence(x),
                            col_title = "", 
                            theme = light_mode_t(),
                            ...) {
  data |> 
    gg_point(x = {{ x }}, y = {{ y }}, 
             col = {{ col }}, facet = {{ facet }}, facet2 = {{ facet2 }},
             col_pal = col_pal, col_labels = col_labels, col_title = col_title, 
             theme = theme, ...) +
    ggeasy::easy_remove_axes(which = "y", what = c("line", "ticks"))
}

p1 <- penguins2 |>
  gg_point_custom(
    x = flipper_length_mm,
    y = body_mass_g, 
    col = sex)

p2 <- penguins2 |>
  gg_point_custom(
    x = flipper_length_mm,
    y = body_mass_g, 
    col = species)

p1
p2
# p1 / p2
```

### 8. Add contrasting dark or light text on polygons

A method was developed by [@teunbrand](https://github.com/teunbrand/ggplot_tricks) to colour text on polygons using a dark or light colour, which is determined  based on the underlying polygon colour.

```{r}
contrast <- function(col_pal, col_pal_dark = "#121b24", col_pal_light = "#fcfdfe") {
    out <- rep(col_pal_dark, length(col_pal))
    light <- farver::get_channel(col_pal, "l", space = "hcl")
    out[light < 50] <- col_pal_light
    out
  }

aes_contrast <- aes(colour = after_scale(contrast(fill)))

palmerpenguins::penguins |>
  count(species, sex) |> 
  gg_col(
    x = sex,
    y = n,
    col = species,
    col_pal = c("#0095A8", "#112E51", "#FF7043"),
    width = 0.75, 
    position = position_dodge2(preserve = "single"),
    x_labels = \(x) str_to_sentence(x), 
  ) +
  geom_text(
    aes(
      y = n - (max(n * 0.04)),
      label = n, 
      !!!aes_contrast, 
    ),
    position = position_dodge2(width = 0.75, preserve = "single"),
    size = 3.53,
    show.legend = FALSE,
  ) 
```

```{r}
mtcars |> 
  corrr::correlate() |> 
  corrr::stretch() |> 
  mutate(across(c(x, y), str_to_sentence)) |> 
  gg_tile(
    x = x, 
    y = y,
    col = r,
    col_pal_na = "#e6ecf2",
    col_limits = c(-1, 1),
    col_rescale = scales::rescale(c(-1, 0, 1)),
    x_title = "", 
    y_title = "", 
    x_expand = c(0, 0), 
    y_expand = c(0, 0),
    col_title = "r") +
  geom_text(
    aes(label = round(r, 1),
      !!!aes_contrast, 
    ),
    size = 3.53,
    show.legend = FALSE,
  )
```

### 9. Use the gg_blanket function for other geoms

ggblanket is driven by `gg_blanket` function, which has a `geom` argument.

All other functions wrap this function with a locked-in geom, and their own default `stat` and `position` arguments as per the applicable `geom_*` function.

Because gg_blanket has a `geom` argument, it can be used with other geoms provided by other packages.

```{r}
library(ggdensity)
set.seed(123)

library(ggridges)

ggridges::Catalan_elections |>
  rename_with(snakecase::to_snake_case) |>
  mutate(year = factor(year)) |>
  gg_blanket(
    geom = "density_ridges",
    stat = "density_ridges",
    coord = coord_cartesian(),
    x = percent,
    y = year,
    col = option,
    y_expand = expansion(c(0, 0.125)),
    x_limits = c(0, 100),
    colour = "white",
    alpha_pal = 0.7
    )
```

