---
title: "Extending further"
author: "David Hodge"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  warning = FALSE,
  fig.width = 6,
  fig.asp = 0.618,
  out.width = "70%",
  dpi = 300
)
```

## Overview

To extend ggblanket further, users can:

1. Use non-supported aesthetics
2. Use non-supported arguments
3. Use the ggtext package
4. Use the gghighlight package 
5. Use non-supported geoms
6. Create custom wrapper functions

```{r setup}
library(dplyr)
library(ggplot2)
library(ggblanket)
library(palmerpenguins)

penguins <- penguins |>
  mutate(sex = stringr::str_to_sentence(sex)) |>
  tidyr::drop_na(sex)
```

### 1. Use non-supported aesthetics

While aesthetics other than col/fill are not supported by ggblanket, it is possible to access these in plots made with a combination of `gg_blank` and other ggplot2 code.

```{r}
#for discrete non-col aesthetic & col aesthetic
penguins |>
  gg_blank(
    x = flipper_length_mm,
    y = body_mass_g, 
    col = sex) + 
  geom_point(aes(shape = sex)) +  
  labs(shape = "Sex") 
```

```{r}
#for discrete non-col aesthetic & no col aesthetic
penguins |>
  gg_blank(
    x = flipper_length_mm,
    y = body_mass_g, 
    col = sex) + #just to make legend on bottom
  geom_point(aes(shape = sex), colour = "#2B6999") + 
  labs(shape = "Sex") 
```

```{r}
#for continuous non-col aesthetic & col aesthetic
penguins |>
  gg_blank(
    x = flipper_length_mm,
    y = body_mass_g, 
    col = species,
    col_legend_place = "r") + 
  geom_point(aes(size = bill_depth_mm)) +
  labs(size = "Bill depth mm") +
  theme(legend.title = element_text(margin = margin(t = 10)))
```

```{r}
#for continuous non-col aesthetic & no col aesthetic
penguins |>
  gg_blank(
    x = flipper_length_mm,
    y = body_mass_g) + 
  geom_point(aes(size = bill_depth_mm), colour = "#2B6999") +
  labs(size = "Bill depth mm") 
```

### 2. Use non-supported arguments

The `gg_*` function provides access to all arguments within the `geom_*` function other than the `mapping` argument. It also provides access to most of the useful arguments you might need in the various guide, scale and facet functions etc. However, it does not provide all such arguments. For example, the switch argument within `facet_grid` is not supported. A way to access this functionality is to `+` the `facet_grid(..., switch = "y")` in.

```{r}
penguins |>
  gg_point(
    x = flipper_length_mm, 
    y = body_mass_g,
    col = island,
    facet = species, 
    facet2 = sex
  ) +
  facet_grid(cols = vars(species),
             rows = vars(sex), 
             switch = "y") +
  theme(strip.switch.pad.grid = unit(2, "mm"))
```

### 3. Use the ggtext package

You can modify plot text using the ggtext package. If you want to have some of a title not bold, then it's important to make the theme have a plain title. 

```{r}
nc <- sf::st_read(system.file("shape/nc.shp", package = "sf"), quiet = TRUE)

nc |>
  gg_sf(col = AREA,
        pal = RColorBrewer::brewer.pal(9, "Reds"),
        title = "**Bold** or _italics_ or <span style = 'color:red;'>red</span>",
        theme = gg_theme(title_face = "plain")) +
  theme(plot.title = ggtext::element_markdown())
```

### 5. Use the gghighlight package

The gghighlight package can be used with ggblanket. 

```{r}
penguins |>
  gg_point(x = flipper_length_mm,
           y = body_mass_g) +
  gghighlight::gghighlight(body_mass_g >= 5000)
```

It should be noted that the `gg_*` function builds the scale for the data that it thinks will be within the panel. In some situations such as the below example, you will _need_ to add a `*_limits = c(NA, NA)` argument to make sure that the scale builds to include the full height of the non-highlighted data. 

```{r}
iris |>
  gg_histogram(
    x = Sepal.Length,
    col = Species,
    facet = Species,
    facet_labels = stringr::str_to_sentence,
    y_limits = c(NA, NA)
  ) +
  gghighlight::gghighlight()
```

### 5. Use non-supported geoms

There are lots of non-supported geoms in ggplot2 and other extension packages that can be used in combination with ggblanket. Whether they actually do or do not is dependent on the specifics of that stat within the geom.

```{r, fig.asp=1}
library(patchwork)

p1 <- faithful %>% 
  gg_blank(x = eruptions, y = waiting, 
           x_breaks = scales::breaks_pretty(3)) + 
  geom_density2d(aes(col = after_stat(level))) +
  labs(col = "Level") +
  scale_colour_viridis_c()

p2 <- faithfuld %>% 
  gg_blank(x = waiting, y = eruptions, 
           x_breaks = scales::breaks_pretty(3)) + 
  geom_contour(aes(z = density, col = after_stat(level))) + 
  labs(col = "Level") +
  scale_colour_viridis_c()

p3 <- faithfuld %>% 
  gg_blank(x = waiting, y = eruptions) + 
  geom_contour_filled(aes(z = density)) +
  labs(fill = "Level") +
  scale_colour_viridis_d()

(p1 + p2) / p3
```

```{r}
iris |>
  mutate(Species = stringr::str_to_sentence(Species)) |> 
  gg_blank(
    x = Sepal.Width,
    y = Sepal.Length,
    col = Species,
    facet = Species,
    col_legend_place = "r") +
  ggdensity::geom_hdr(colour = NA) +
  labs(alpha = "Probs") +
  theme(legend.title = element_text(margin = margin(t = 10)))
```

### 6. Create custom wrapper functions

You can easily create powerful custom functions. This is because the `...` argument can allow you to access _all_  arguments within the ggblanket `gg_*` function (and applicable `ggplot2::geom_*` function). 

```{r}
gg_point_custom <- function(data, x, y, col, 
                            size = 3, 
                            shape = 17,
                            pal = RColorBrewer::brewer.pal(8, "Dark2"), 
                            col_title = "", 
                            col_legend_place = "t",
                            ...) {
  data |> 
    gg_point(x = {{ x }}, y = {{ y }}, col = {{col}}, 
             size = size, 
             shape = shape,
             pal = pal, 
             col_title = col_title, 
             col_legend_place = col_legend_place, 
             col_labels = stringr::str_to_sentence,
             ...)
}

iris |>
  gg_point_custom(
    x = Sepal.Width,
    y = Sepal.Length,
    col = Species)
```

```{r}
penguins |>
  gg_point_custom(
    x = species,
    y = body_mass_g,
    col = sex,
    position = position_jitter())
```
