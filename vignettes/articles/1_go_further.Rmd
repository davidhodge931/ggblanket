---
title: "Go further"
author: "David Hodge"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  warning = FALSE,
  fig.width = 6,
  fig.asp = 0.6,
  out.width = "70%",
  dpi = 300
  )
```

## Overview

This article will demonstrate more advanced content, including how to: 

1. Set the theme globally
2. Use different fonts
3. Visualise spatial data
4. Change the `stat`
5. Fix either the colour outline or interior fill to a constant colour
6. Use non-supported aesthetics
7. Use delayed evaluation
8. Add contrasting dark or light text on polygons

```{r setup}
library(ggblanket)
library(ggplot2)
library(dplyr)
library(stringr)
library(tidyr)
library(palmerpenguins)
```

### 1. Set the theme globally

You can set the theme globally using `mode_set` or `ggplot2::theme_set`.

Use `mode_set` (e.g. `mode_set(dark_mode_rt())`) to specify the default theme to occur in the `mode` argument when it is `NULL` using the set mode. The `mode` argument adds the theme, but removes selected gridline/axis-line/ticks. You can unset this using `mode_set(grey_mode_rt())`. 

Alternatively, use `ggplot2::theme_set` to set a complete theme globally with no side-effects. This will result in the set theme `+`-ed on as the final layer to the `gg_*` output. You can unset this using `ggplot2::theme_set(theme_grey())`. 

### 2. Use different fonts

The showtext and sysfonts packages support the use of different fonts from Google. The `*_mode_*` theme functions provide a `base_family` argument.

```{r, fig.asp = 0.7, fig.showtext = TRUE}
head(sysfonts::font_families_google())

sysfonts::font_add_google("Covered By Your Grace", "grace")
sysfonts::font_add_google('Roboto Slab', 'roboto_slab')
sysfonts::font_add_google('Syne Mono', 'syne')

showtext::showtext_auto(enable = TRUE)

penguins |>
  mutate(across(sex, \(x) str_to_sentence(x))) |>
  gg_point(
    x = flipper_length_mm,
    y = body_mass_g,
    col = sex,
    facet = species,
    title = "Penguins body mass by flipper length",
    subtitle = "Palmer Archipelago, Antarctica",
    caption = "Source: Gorman, 2020",
    mode = grey_mode_rt(base_size = 11, base_family = "grace")
  ) +
  theme(
    plot.title = element_text(family = "roboto_slab"),
    plot.subtitle = element_text(family = "syne")
  )

showtext::showtext_auto(enable = FALSE)
```

### 3. Visualise spatial data

As ggblanket wraps the `ggplot2::geom_sf` and `ggplot2::geom_raster` functions, spatial vector and array data can be visualised. 

```{r, fig.asp=0.4}
sf::st_read(system.file("shape/nc.shp", package = "sf"), quiet = TRUE) |>
  gg_sf(col = AREA) +
  ggeasy::easy_remove_axes()
```

```{r}
stars::read_stars(system.file("tif/L7_ETMs.tif", package = "stars")) |>
 tibble::as_tibble() |>
 gg_raster(
   x = x,
   y = y,
   col = L7_ETMs.tif,
   facet = band,
   col_title = "L7 ETMs",
  ) +
  ggeasy::easy_remove_axes() 
```

### 4. Change the `stat`

The default `stat` of each `gg_*` function can be changed. 

```{r}
penguins |> 
  gg_point(
    stat = "summary",
    x = species,
    y = island,
  ) 
```

```{r}
penguins |>
  gg_pointrange(
    stat = "summary", 
    x = species,
    y = flipper_length_mm, 
    size = 0.1,
  )
```

```{r}
library(ggforce)

ggplot2::economics |>
  slice_head(n = 35) |> 
  gg_path(
    stat = "bspline",
    x = date, 
    y = unemploy,
    n = 100, 
    linewidth = 1,
  ) 
```

### 5. Fix either the colour outline or interior fill to a constant colour

For geom's that have both outline colour and interior fill, it is possible to fix one of these to a constant colour.

To do this, use `colour = "black"` or `fill = "#d3d3d3"`. Note this requires a `col` aesthetic to work. So you must do this in a hacky way, where you do not want a `col` aesthetic.

```{r}
penguins |>
  mutate(across(sex, \(x) str_to_sentence(x))) |>
  gg_boxplot(
    x = species,
    y = flipper_length_mm,
    col = sex,
    colour = "black", #or fill = "lightgrey" 
    position = position_dodge2(preserve = "single"),
    alpha_pal = 0.9,
  )
```

```{r}
penguins |>
  mutate(hack = "") |> 
  gg_boxplot(
    x = species,
    y = flipper_length_mm,
    col = hack,
    colour = "black", #or fill = "lightgrey" 
    width = 0.5,
    alpha_pal = 0.9,
    mode = grey_mode_n(),
  ) 
```

### 6. Use non-supported aesthetics 

Most functions have the commonly needed aesthetics directly available as an argument. For those that are not available, you can either use `mapping` argument. The `mapping` argument provides access to the `size`, `shape`, `linetype` and `linewidth` aesthetics within the `gg_*` function. 

```{r}
penguins |> 
  gg_point(
    x = flipper_length_mm, 
    y = body_mass_g, 
    col = species,
    mapping = aes(shape = species),
  ) +
  labs(shape = "Species")
```

### 7. Use delayed evaluation

As the `x`, `y`, `col` and `alpha` aesthetic arguments require a unquoted variable, you cannot apply a function to these. However, you can for aesthetics within the `mapping` argument. This is useful for delayed evaluation with the `ggplot2::after_stat` function.

```{r, fig.asp=0.55}
penguins |>
  gg_histogram(
    x = flipper_length_mm,
    mappingRp = aes(y = after_stat(density)),
    facet = species,
  )
```

```{r, fig.asp=0.55}
faithfuld |>
  gg_contour(
    x = waiting,
    y = eruptions,
    z = density,
    mapping = aes(colour = after_stat(level)),
    bins = 8,
  )
```

### 8. Add contrasting dark or light text on polygons

Text on polygons can be coloured with a dark or light colour that is determined based on the underlying polygon colour using `!!!aes_contrast()`. This method was developed by Teun van den Brand (@teunbrand).

```{r}
penguins |>
  count(species, sex) |>
  gg_col(
    x = sex,
    y = n,
    col = species,
    position = position_dodge2(preserve = "single"),
    width = 0.75,
    x_labels = \(x) str_to_sentence(x),
  ) +
  geom_text(
    mapping = aes(y = n - (max(n * 0.04)), label = n, !!!aes_contrast()),
    position = position_dodge2(width = 0.75, preserve = "single"),
    show.legend = FALSE,
  ) 
```

```{r}
penguins |>
  count(species, sex) |>
  gg_col(
    x = sex,
    y = n,
    col = species,
    position = position_dodge2(preserve = "single"),
    width = 0.75,
    x_labels = \(x) str_to_sentence(x),
    mode = grey_mode_rt(),
  ) +
  geom_text(
    mapping = aes(y = n - (max(n * 0.04)), label = n, !!!aes_contrast("grey_mode")),
    position = position_dodge2(width = 0.75, preserve = "single"),
    show.legend = FALSE,
  ) 
```

```{r}
penguins |>
  count(species, sex) |>
  gg_col(
    x = sex,
    y = n,
    col = species,
    position = position_dodge2(preserve = "single"),
    width = 0.75,
    x_labels = \(x) str_to_sentence(x),
    mode = dark_mode_rt(),
  ) +
  geom_text(
    mapping = aes(y = n - (max(n * 0.04)), label = n, 
                  !!!aes_contrast("dark_mode")),
    position = position_dodge2(width = 0.75, preserve = "single"),
    show.legend = FALSE,
  ) 
```

