---
title: "ggblanket"
author: "David Hodge"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{ggblanket}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  warning = FALSE,
  fig.width = 6,
  fig.asp = 0.5,
  out.width = "70%",
  dpi = 300)
```

## Overview

ggblanket is a package of ggplot2 wrapper functions.

The primary objective is to **simplify ggplot2 visualisation**.

Secondary objectives relate to:

* Design: produce well-designed visualisation by default
* Scope: cover the most useful 80% of what ggplot2 does
* Alignment: use conventions generally aligned with ggplot2. 

## How it works
 
1.  Over thirty `gg_*` wrapper functions
2.  A single `col` argument to colour and fill by a variable
3.  A `col_pal` argument to customise colours
4.  A `facet` argument to facet by a variable
5.  An additional `facet2` argument to facet by a 2nd variable
6.  Ability to customise by prefixed arguments 
7.  Provision of families of themes
8.  Pretty continuous x and y scales with easy opt-out
9.  Pretty gridlines removal
10. Conversion of unspecified `titles` to sentence case
11. Access to other `geom_*` arguments via ...
12. Ability to add multiple `geom_*` layers
13. Other key differences to ggplot2
14. A `gg_blanket` function for extra `geom` flexibility

```{r setup}
library(ggblanket)
library(ggplot2)
library(dplyr)
library(palmerpenguins)
library(patchwork)
```
 
### 1. Over thirty `gg_*` wrapper functions

Each `gg_*` function wraps a ggplot2 `ggplot(aes(...))` function with the applicable ggplot2 `geom_*()` function. Each `gg_*` function is named after the `geom_*` function they wrap. 

```{r}
penguins |>
  gg_point(
    x = flipper_length_mm,
    y = body_mass_g,
  )
```

### 2. A single `col` argument to colour and fill by a variable

The colour and fill aesthetics of ggplot2 are merged into a single concept represented by the `col` argument. This argument means that everything should be coloured according to it, i.e. all points, lines and polygon interiors. 

```{r}
penguins |>
  gg_point(
    x = flipper_length_mm,
    y = body_mass_g, 
    col = species,
  )
```


```{r, fig.asp=0.45}
penguins |>
  tidyr::drop_na(sex) |>
  mutate(across(sex, \(x) stringr::str_to_sentence(x))) |>
  gg_bar(
    y = species, 
    col = sex,
    width = 0.75,
    position = position_dodge(preserve = "single"),
  )
```

### 3. A `col_pal` argument to customise colours

The `col_pal` argument is used to customise the colours of the geom. A user can provide a vector of colours to this argument. It can be named or not. It works in a consistent way - regardless of whether a `col` aesthetic is added or not. A named palette can be used to make individual colours stick to particular values. The ggblanket package also provides some helper colours that are prefixed `pal_*`. 

```{r}
penguins |>
  gg_jitter(
    x = species, 
    y = body_mass_g, 
    col_pal = "#112E51",
  )
```

```{r}
penguins |> 
  tidyr::drop_na(sex) |> 
  mutate(across(sex, \(x) stringr::str_to_sentence(x))) |> 
  gg_density(
    x = flipper_length_mm,
    col = sex,
    col_pal = c("#112E51", "#78909C"),
  )
```

### 4. A `facet` argument to facet by a variable

Faceting is treated as if it were an aesthetic. Users just provide an unquoted variable to facet by. If a single facet (or facet2) variable is provided, it'll default to a "wrap" layout. But users can change this with a `facet_layout = "grid"` argument.

```{r}
penguins |>
  tidyr::drop_na(sex) |> 
  mutate(across(sex, \(x) stringr::str_to_sentence(x))) |> 
  gg_violin(
    x = sex,
    y = body_mass_g,
    facet = species,
  )
```

### 5. An additional `facet2` argument to facet by a 2nd variable

A `facet2` argument is also provided for extra functionality and flexibility. If both `facet`and `facet2` variables are provided, then it'll default to a "grid" layout of `facet` by `facet2`. But users can change this with a `facet_layout = "wrap"` argument.

```{r, fig.asp=0.75}
penguins |>
  mutate(across(sex, \(x) stringr::str_to_sentence(x))) |> 
  gg_histogram(
    x = flipper_length_mm,
    facet = species,
    facet2 = sex,
  )
```

### 6.  Ability to customise by prefixed arguments 

Prefixed arguments are available to customise titles, scales, guides, and faceting. These prefixes organise the adjustments by whether they relate to `x`, `y`, `col`, `facet` or `alpha`. 

```{r}
penguins |>
  gg_jitter(
    x = species,
    y = body_mass_g,
    col = flipper_length_mm,
    x_labels = \(x) stringr::str_sub(x, 1, 1),
    y_expand_limits = 0,
    y_breaks = scales::breaks_width(1500), 
    y_labels = scales::label_number(big.mark = " "), 
    y_expand = expansion(mult = c(0, 0.05)),
    y_transform = "sqrt",
    y_title = "Body mass (g)",
  )
```

These prefixed arguments work nicely with the Rstudio autocomplete, if users:

* ensure their settings support the use of tab for autocompletions and multi-line autocompletions (i.e. Tools - Global Options - Code - Completion)
* pipe data into the `gg_*` functions.

```{r, echo = FALSE,   fig.width = 3, fig.asp = 2}
knitr::include_graphics("autocomplete_y.png", dpi = 300)
```

### 7.  Provision of families of themes

ggblanket provides two families of themes: `light_mode_*` and `dark_mode_*`. 

Each theme family provides 4 variants that differ based on legend placement, which is represented by the suffix of the theme name of `rt`  (right-top), `r` (right centre), `b` (bottom), and `t` top. 

You can set the theme globally using `ggplot2::theme_set`. 

Note if you want to set the theme globally to `theme_grey()`, then you must modify the base_size slightly (e.g. `theme_set(theme_grey(11.01))`).

```{r, fig.asp=0.7}
# theme_set(dark_mode_rt())

penguins |>
  mutate(across(sex, \(x) stringr::str_to_sentence(x))) |> 
  gg_point(
    x = flipper_length_mm,
    y = body_mass_g,
    col = sex,
    title = "Penguins body mass by flipper length",
    subtitle = "Palmer Archipelago, Antarctica",
    caption = "Source: Gorman, 2020", 
    theme = dark_mode_b(title_face = "bold"),
  )
```

### 8. Pretty continuous x and y scales with easy opt-out

ggblanket creates pretty continuous y scale for non-horizontal  plots that has: 

* `y_limits` that are the range of the `y_breaks` 
* `y_expand` of `c(0, 0)`

This pretty scale can be turned off easily using `y_limits = c(NA, NA)` (or by providing a `y_expand` value).

The opposite occurs for horizontal plots with the x scale. 

```{r}
penguins |>
  mutate(across(sex, \(x) stringr::str_to_sentence(x))) |> 
  gg_boxplot(
    x = species,
    y = flipper_length_mm,
    col = sex,
    position = position_dodge2(preserve = "single"),
  )
```

```{r}
penguins |>
  mutate(across(sex, \(x) stringr::str_to_sentence(x))) |> 
  gg_boxplot(
    x = species,
    y = flipper_length_mm,
    col = sex,
    position = position_dodge2(preserve = "single"),
    y_limits = c(NA, NA),
  )
```

### 9.  Pretty gridlines removal

The `gg_*` functions adjust what gridlines are present in the graph - by removing the ones that it guesses are not required. 

You can adjust this if needed using the `*_gridlines` arguments. 

Subsequently, it is recommended that themes with gridlines in both x and y directions are used with ggblanket.

```{r}
penguins |>
  tidyr::drop_na(sex) |> 
  mutate(across(sex, \(x) stringr::str_to_sentence(x))) |>
  gg_jitter(
    x = flipper_length_mm,
    y = sex,
    col = sex, 
    theme = theme_grey(),
  )
```

### 10.  Conversion of unspecified `titles` to sentence case

Unspecified `x`, `y`, `col` and `alpha` titles are converted to sentence case with snakecase::to_sentence. All titles can be manually changed using the `*_title` arguments. The default conversion is intended to make titles sometimes able to be left as is. Use `*_title = ""` to remove a title. 

```{r, fig.asp=0.6}
diamonds |>
  gg_hex(
    x = carat,
    y = price,
    y_limits = c(0, 20000),
    coord = coord_cartesian(clip = "on"), 
  )
```

### 11. Access to other `geom_*` arguments via `...`

The `...` argument provides accesss to all other arguments in the `geom_*` function. Common arguments from `...` to add are `size`, `linewidth` and `width`.

```{r}
penguins |>
  mutate(across(sex, \(x) stringr::str_to_sentence(x))) |> 
  tidyr::drop_na(sex) |> 
  gg_smooth(
    x = flipper_length_mm,
    y = body_mass_g,
    col = sex, 
    se = TRUE,
    linewidth = 0.5,
    level = 0.99,
  ) 
```

### 12. Ability to add multiple `geom_*` layers

Users can make plots with multiple layers with ggblanket by adding on `ggplot2::geom_*` layers. 

The `gg_*` function puts the aesthetic variables (i.e. `x`, `y`, `col`) within the wrapped `ggplot` function. Therefore, these aesthetics will inherit to any subsequent layers added. `facet` and `facet2` will likewise inherit - as will `data`, `coord` and `theme`.

The `gg_*` function _should_ be appropriate to be the bottom layer of the plot. This is because the geoms will plot in order. 

All of the aesthetics required for the plot as a whole should generally be added into the `gg_*` function, including the `col` argument. If you do not want the first layer to have a colour and fill aesthetic, but you wish later layers to access this - use `gg_blank`. 

Use `*_expand_limits` or  `*_limits` to ensure the `gg_* function builds the limits appropriately for the plot as a whole.

```{r, fig.asp = 0.4}
penguins |>
  group_by(species) |>
  summarise(body_mass_g = mean(body_mass_g, na.rm = TRUE)) |>
  mutate(lower = body_mass_g * 0.95) |> 
  mutate(upper = body_mass_g * 1.2) %>%
  gg_col(
    x = body_mass_g,
    xmin = lower, 
    xmax = upper,
    y = species,
    col = species,
    width = 0.75,
    x_expand_limits = c(0, max(.$upper)),
    x_labels = \(x) x / 1000, 
    x_title = "Body mass kg", 
  ) +
  geom_errorbar(
    colour = "black",
    width = 0.1) 
```

```{r, fig.asp=0.4}
penguins |>
  group_by(species) |>
  summarise(body_mass_g = mean(body_mass_g, na.rm = TRUE)) |>
  mutate(lower = body_mass_g * 0.95) |> 
  mutate(upper = body_mass_g * 1.2) |> 
  gg_blank( 
    x = body_mass_g,
    y = species,
    col = species,
    xmin = lower, 
    xmax = upper,
    width = 0.75,
    x_expand_limits = 0,
    x_labels = \(x) x / 1000, 
    x_title = "Body mass kg",
  ) +
  geom_col(
    width = 0.75,
    colour = "#d3d3d3",#fix to constant
    fill = "#d3d3d3",#fix to constant
    alpha = 0.9) +
  geom_errorbar(width = 0.1) 

```


### 13. Other ggplot2 key differences 

##### Unquoted variables only

ggblanket requires unquoted variables only for `x`, `y`, `col`, `facet`, `facet2` and  `alpha`. You cannot wrap these in a function. Instead you may need to manipulate the data prior to plotting, or use the `mapping` argument for delayed evaluation or other non-supported aesthetics. 

```{r}
diamonds |>
  count(color) |>
  mutate(color = color |>
           forcats::fct_reorder(n) |>
           forcats::fct_rev()) |>
  gg_col(
    x = n,
    y = color,
    width = 0.75,
    x_labels = \(x) x / 1000,
    x_title = "Count (thousands)", 
  )
```

##### Unused factor levels kept

ggblanket keeps unused factor levels in the plot. If users wish to drop unused levels they should likewise do it in the data prior to plotting using `forcats::fct_drop`. 

```{r, fig.asp=0.4}
diamonds |> 
  count(color) |>
  filter(color %in% c("E", "G", "I")) |>
  mutate(color = forcats::fct_drop(color)) |> 
  gg_point(
    x = n,
    y = color,
    x_labels = \(x) x / 1000,
    x_title = "Count (thousands)", 
  )
```

##### Different `oob` & `clip` defaults

By default, ggblanket keeps values outside of the limits (`*_oob = scales::oob_keep`) in calculating the geoms and scales to plot. It also does _not_ clip anything outside the cartesian coordinate space by default (`coord = ggplot2::coord_cartesian(clip = "off"`)). 

ggplot2 by default drops values outside of the limits in calculating the geoms and scales to plot (`scales::oob_censor`), and clips anything outside the cartesian coordinate space (`coord = ggplot2::coord_cartesian(clip = "on"`)).

This needs to be considered when you are using `x_limits` or `y_limits`, and your stat is _not_ `"identity"`.  

##### Alpha

`alpha` is fully supported in ggblanket in a similar way to `col`. So the `alpha` argument represents an aesthetic, whereas `alpha_pal` represents a value (or values or range) of alpha for alpha. So if you want to make all of the geom at 50% opacity, use `alpha_pal = 0.5` in a `gg_*` function.  

##### Other

* `*_title` is equivalent to `ggplot2::labs(* = ...)`
* y categorical variables are reversed, so that they are read from low levels (top) to high levels (bottom) 
* Logical variables are reversed, so that `TRUE` always comes before `FALSE`
 
### 14. A `gg_blanket` function for extra `geom` flexibility

All `gg_*` wrapper functions allow modification of the `stat`, `position`, and `coord` arguments etc.

The `gg_blanket` function goes one step further: it contains a `geom` argument that allows the user to add any geom. 

This enables the use of ggblanket with other extension packages etc.

```{r}
library(ggridges)

penguins |> 
  tidyr::drop_na(sex) |> 
  mutate(across(sex, \(x) stringr::str_to_sentence(x))) |> 
  gg_blanket(
    geom = "density_ridges2",
    stat = "density_ridges", 
    position = "points_sina",
    x = flipper_length_mm,
    y = species,
    col = sex,
    y_expand = c(0.05, 0),
    alpha_pal = 0.33,
    col_pal = c(pal_navy, pal_orange),
  )
```

```{r}
library(ggforce)

iris |> 
  gg_blanket(
    geom = "shape",
    stat = "voronoi_tile",
    position = "identity",
    x = Sepal.Length, 
    y = Sepal.Width, 
    col = Species,
    group = 1,
    colour = pal_light_mode[3],
    col_pal = c(pal_teal, pal_orange, pal_navy),
  )
```

## Further information 

See the ggblanket [website](https://davidhodge931.github.io/ggblanket/index.html) for further information, including [articles](https://davidhodge931.github.io/ggblanket/articles/) and [function reference](https://davidhodge931.github.io/ggblanket/reference/index.html).
