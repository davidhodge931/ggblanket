---
title: "ggblanket"
author: "David Hodge"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{ggblanket}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  warning = FALSE,
  fig.width = 6,
  fig.asp = 0.5,
  out.width = "70%",
  dpi = 300)
```

## Overview

ggblanket is a package of ggplot2 wrapper functions.

The primary objective is to **simplify ggplot2 visualisation**.

Secondary objectives relate to:

* Design: produce well-designed visualisation by default
* Alignment: use conventions generally aligned with ggplot2
* Scope: cover the majority of what ggplot2 does.

## How it works
 
1.  Almost forty `gg_*` wrapper functions
2.  A `col` argument to colour and fill by a variable
3.  A `facet` argument to facet by a variable
4.  A `facet2` argument to facet by a 2nd variable
5.  A `col_pal` argument to customise colours
6.  Prefixed arguments to customise 
7.  Unspecified titles to `snakecase::sentence_case` 
8.  `light_mode_*` and `dark_mode_*` theme families
9.  Access to other `geom_*` arguments via `...`
10. Symmetric continuous positional scales and gridlines removal
11. Flexibility to turn-off or fix either colour or fill
12. Ability to add multiple `geom_*` layers
13. Other key differences to ggplot2
14. A `gg_blanket()` function with `geom` flexibility

```{r setup}
library(ggblanket)
library(ggplot2)
library(dplyr)
library(stringr)
library(tidyr)
library(palmerpenguins)
```
 
### 1. Almost forty `gg_*` wrapper functions

Each `gg_*` function wraps a ggplot2 `ggplot(aes(...))` function with the applicable ggplot2 `geom_*()` function. Each `gg_*` function is named after the `geom_*` function they wrap. 

```{r}
penguins |>
  gg_point(
    x = flipper_length_mm,
    y = body_mass_g,
  )
```

### 2. A single `col` argument to colour and fill by a variable

The colour and fill aesthetics of ggplot2 are merged into a single concept represented by the `col` argument. 
This combined aesthetic means that everything should be coloured according to it, i.e. all points, lines and polygon interiors. 

There is flexibility to undo this combined aesthetic if necessary, as is discussed later in this article.

```{r}
penguins |>
  gg_point(
    x = flipper_length_mm,
    y = body_mass_g, 
    col = species,
  )
```

```{r, fig.asp=0.45}
penguins |>
  drop_na(sex) |>
  mutate(across(sex, \(x) str_to_sentence(x))) |>
  gg_bar(
    y = species, 
    col = sex,
    width = 0.75,
    position = "dodge",
  )
```

### 3. A `facet` argument to facet by a variable

Faceting is treated as if it were an aesthetic. Users just provide an unquoted variable to facet by. 

Whenever a `facet` variable is provided (and a `facet2` variable _not_ provided), the `facet_layout` will default to `"wrap"`. 

```{r}
penguins |>
  drop_na(sex) |> 
  mutate(across(sex, \(x) str_to_sentence(x))) |> 
  gg_histogram(
    x = flipper_length_mm,
    facet = species,
  )
```

### 4. A `facet2` argument to facet by a 2nd variable

A `facet2` argument is also provided for extra functionality and flexibility. 

This enables users to facet easily in a `"grid"` layout of the `facet` variable horizontally by the `facet2` variable vertically. 

Whenever a `facet2` variable is provided, the `facet_layout` will default to `"grid"`. 

```{r, fig.asp=0.75}
penguins |>
  mutate(across(sex, \(x) str_to_sentence(x))) |> 
  gg_histogram(
    x = flipper_length_mm,
    facet = species,
    facet2 = sex,
  )
```

### 5. A `col_pal` argument to customise colours

The `col_pal` argument is used to customise the colours of the geom. A user can provide a vector of colours to this argument. It can be named or not. It works in a consistent way - regardless of whether a `col` aesthetic is added or not. 

```{r}
penguins |>
  gg_jitter(
    x = species, 
    y = body_mass_g, 
    col_pal = "#112E51",
  )
```

```{r}
penguins |> 
  drop_na(sex) |> 
  mutate(across(sex, \(x) str_to_sentence(x))) |> 
  gg_density(
    x = flipper_length_mm,
    col = sex,
    col_pal = c("#112E51", "#78909C"),
  )
```

### 6.  Prefixed arguments to customise 

ggblanket offers numerous arguments to customise that are prefixed by whether they relate to `x`, `y`, `col`, `facet` or `alpha`. 

These prefixed arguments work nicely with the Rstudio autocomplete, if users ensure their settings support the use of tab for autocompletions and multi-line autocompletions (i.e. Tools - Global Options - Code - Completion)

```{r}
penguins |>
  drop_na(sex) |>  
  gg_jitter(
    x = species,
    y = body_mass_g,
    col = flipper_length_mm,
    facet = sex,
    x_labels = \(x) str_sub(x, 1, 1),
    y_expand_limits = 0,
    y_breaks = scales::breaks_width(1500), 
    y_labels = scales::label_number(big.mark = " "), 
    y_expand = expansion(mult = c(0, 0.05)),
    y_transform = "sqrt",
    y_title = "Body mass (g)",
    col_continuous_type = "steps",
    facet_labels = \(x) str_to_sentence(x),
  )
```

```{r, echo = FALSE,   fig.width = 3, fig.asp = 2}
knitr::include_graphics("autocomplete_y.png", dpi = 300)
```

### 7.  Unspecified titles to `snakecase::sentence_case`

Unspecified `x`, `y`, `col` and `alpha` titles are converted to sentence case with `snakecase::to_sentence`. 

However, each title can be manually changed using the applicable `*_title` argument. Use `*_title = ""` to remove a title. 

The default `snakecase::to_sentence` conversion can be turned off using `titles = \(x) x`. 

```{r, fig.asp=0.6}
diamonds |>
  gg_hex(
    x = carat,
    y = price,
    coord = coord_cartesian(clip = "on"), 
    y_limits = c(0, 20000),
  )
```

### 8.  `light_mode_*` and `dark_mode_*` theme families

ggblanket provides two families of themes: `light_mode_*` and `dark_mode_*`. 

Each theme family provides 5 variants that differ based on legend placement, which is represented by the suffix of the theme name of `rt`  (right-top), `r` (right-centre), `b` (bottom), `t` (top) and `i` (inside the panel). 

You can set the theme globally using `ggplot2::theme_set()`. 

```{r, fig.asp=0.7}
# theme_set(dark_mode_rt())

penguins |>
  mutate(across(sex, \(x) str_to_sentence(x))) |> 
  gg_point(
    x = flipper_length_mm,
    y = body_mass_g,
    col = sex,
    title = "Penguins body mass by flipper length",
    subtitle = "Palmer Archipelago, Antarctica",
    caption = "Source: Gorman, 2020", 
    theme = dark_mode_b(title_face = "bold"),
  )
```

### 9. Access to other `geom_*` arguments via `...`

The `...` argument provides access to all other arguments in the `geom_*()` function. 

```{r}
penguins |>
  mutate(across(sex, \(x) str_to_sentence(x))) |> 
  drop_na(sex) |> 
  gg_smooth(
    x = flipper_length_mm,
    y = body_mass_g,
    col = sex, 
    se = TRUE, # via ... from geom_smooth
    level = 0.99, # via ... from geom_smooth
  ) 
```

### 10. Symmetric continuous positional scales and gridlines removal

ggblanket guesses whether the plot is flipped or not in order to determine:

* which scale to make symmetric by default
* which `*_gridlines` to remove by default

This `flipped` argument can be specified where it does not get it right.

The symmetric continuous y scale for non-flipped plots defaults to: 

* `y_limits` that are the range of the `y_breaks` 
* `y_expand` of `c(0, 0)`

This symmetric scale can be turned off easily using `y_limits = c(NA, NA)` (or by providing a `y_expand` value).

The opposite occurs for flipped plots with the x scale. 

Sometimes you may need to add `*_expand_limits = 0`, if the lower bound of the symmetric scale falls on a close low number.

Note this symmetric scale does not occur where the scale has a transformation that is _not_ `"identity"`, `"reverse"`, `"date"`, `"time"` or `"hms"` - or where the other positional scale is binned.

For non-flipped plots, `x_gridlines` will be removed by default - and `y_gridlines` removed by default for flipped plots. You can adjust this if needed using the `*_gridlines` arguments. Subsequently, it is recommended that themes with gridlines in both x and y directions are used with ggblanket.

```{r}
penguins |>
  drop_na(sex) |> 
  mutate(across(sex, \(x) stringr::str_to_sentence(x))) |>
  gg_point(
    x = flipper_length_mm,
    y = body_mass_g,
    col = sex,
  )
```

```{r}
penguins |>
  drop_na(sex) |> 
  mutate(across(sex, \(x) stringr::str_to_sentence(x))) |>
  gg_point(
    x = flipper_length_mm,
    y = body_mass_g,
    col = sex,
    y_limits = c(NA, NA),
  )
```

### 11. Flexibility to turn-off or fix either colour or fill

For a geom with both outlines and fill, the default is to have both of these to the same colour with a default value of `alpha_pal`.

However, with these geoms, you can turn off _either_ the colour (i.e. of the outlines) or fill, or fix one of these to a constant colour. 

The recommended approach is to use `colour = NA`/`colour = black`, `fill = NA`/`fill = "lightgrey"`, and add in a `col` aesthetic if you don't already have one (as well as removing the legend). 

An alternative approach to set `alpha_pal = 0` and `col_pal = scales::alpha(..., alpha = 0)` can be used. However, this approach is not as flexible.

```{r}
penguins |>
  mutate(across(sex, \(x) str_to_sentence(x))) |>
  gg_boxplot(
    x = species,
    y = flipper_length_mm,
    col = sex,
    colour = "black", #or colour = NA, or fill = NA or fill = "lightgrey" etc
    position = position_dodge2(preserve = "single"),
    alpha_pal = 0.9,
  )
```

```{r}
penguins |>
  mutate(hack = "") |> 
  gg_boxplot(
    x = species,
    y = flipper_length_mm,
    col = hack,
    colour = "black", #or colour = NA, or fill = NA or fill = "lightgrey" etc
    width = 0.5,
    col_pal = pal_blue,
    alpha_pal = 0.9,
  ) +
  guides(colour = "none", fill = "none")
```

### 12. Ability to add multiple `geom_*` layers

Users can make plots with multiple layers with ggblanket by adding on `ggplot2::geom_*` layers. 

The `gg_*` function puts the aesthetic variables (i.e. `x`, `y`, `col`) within the wrapped `ggplot` function. Therefore, these aesthetics will inherit to any subsequent layers added. `facet` and `facet2` will likewise inherit - as will `data`, `coord` and `theme`.

The `gg_*()` function _should_ be appropriate to be the bottom layer of the plot. This is because the geoms will plot in order. 

All of the aesthetics required for the plot as a whole should generally be added into the `gg_*` function, including the `col` argument. If you do not want the first layer to have a colour and fill aesthetic, but you wish later layers to access this - use `gg_blanket()` (as it defaults to a `blank` geom). 

Use `*_expand_limits` or  `*_limits` to ensure the `gg_* function builds the limits appropriately for the plot as a whole.

```{r, fig.asp = 0.4}
penguins |>
  group_by(species) |>
  summarise(body_mass_g = mean(body_mass_g, na.rm = TRUE)) |>
  mutate(lower = body_mass_g * 0.95) |> 
  mutate(upper = body_mass_g * 1.2) %>%
  gg_col(
    x = body_mass_g,
    xmin = lower, 
    xmax = upper,
    y = species,
    col = species,
    width = 0.75,
    x_expand_limits = c(0, max(.$upper)),
    x_labels = \(x) x / 1000, 
    x_title = "Body mass kg", 
  ) +
  geom_errorbar(
    colour = "black", 
    width = 0.1, 
  ) 
```

```{r, fig.asp=0.4}
penguins |>
  group_by(species) |>
  summarise(body_mass_g = mean(body_mass_g, na.rm = TRUE)) |>
  mutate(lower = body_mass_g * 0.95) |> 
  mutate(upper = body_mass_g * 1.2) |> 
  gg_blanket( 
    x = body_mass_g,
    y = species,
    col = species,
    xmin = lower, 
    xmax = upper,
    width = 0.75,
    x_expand_limits = 0,
    x_labels = \(x) x / 1000, 
    x_title = "Body mass kg",
  ) +
  geom_col(
    colour = "#d3d3d3",#fix to constant
    fill = "#d3d3d3",#fix to constant
    alpha = 0.9,
    width = 0.75,
  ) +
  geom_errorbar(
    width = 0.1, 
  ) 
```

### 13. Other ggplot2 key differences 

##### Unquoted variables only

ggblanket requires unquoted variables only for `x`, `y`, `col`, `facet`, `facet2` and  `alpha`. You cannot wrap these in a function. Instead you may need to manipulate the data prior to plotting, or use the `mapping` argument for delayed evaluation or other non-supported aesthetics. 

```{r}
diamonds |>
  count(color) |>
  mutate(color = color |>
           forcats::fct_reorder(n) |>
           forcats::fct_rev()) |>
  gg_col(
    x = n,
    y = color,
    width = 0.75,
    x_labels = \(x) x / 1000,
    x_title = "Count (thousands)", 
  )
```

##### Unused factor levels kept

ggblanket keeps unused factor levels in the plot. If users wish to drop unused levels they should likewise do it in the data prior to plotting using `forcats::fct_drop`. 

```{r, fig.asp=0.4}
diamonds |> 
  count(color) |>
  filter(color %in% c("E", "G", "I")) |>
  mutate(color = forcats::fct_drop(color)) |> 
  gg_point(
    x = n,
    y = color,
    x_labels = \(x) x / 1000,
    x_title = "Count (thousands)", 
  )
```

##### Different `oob` & `clip` defaults

By default, ggblanket keeps values outside of the limits (`*_oob = scales::oob_keep`) in calculating the geoms and scales to plot. It also does _not_ clip anything outside the cartesian coordinate space by default (`coord = ggplot2::coord_cartesian(clip = "off"`)). 

ggplot2 by default drops values outside of the limits in calculating the geoms and scales to plot (`scales::oob_censor`), and clips anything outside the cartesian coordinate space (`coord = ggplot2::coord_cartesian(clip = "on"`)).

This needs to be considered when you are using `x_limits` or `y_limits`, and your stat is _not_ `"identity"`.  

##### Alpha

`alpha` is fully supported in ggblanket in a similar way to `col`. So the `alpha` argument represents an aesthetic, whereas `alpha_pal` represents a value (or values or range) of alpha for alpha. 

##### Other

* `*_title` is equivalent to `ggplot2::labs(* = ...)`
* Facet arguments `strip.position` and `switch` are renamed `facet_labels_position` and `facet_labels_switch`
* y categorical variables are reversed, so that they are read from low levels (top) to high levels (bottom) * Logical variables are reversed, so that `TRUE` always comes before `FALSE`
* Infinite values are treated as `NA`
 
### 14. A `gg_blanket` function with `geom` flexibility

ggblanket is driven by `gg_blanket` function, which has a `geom` argument with `geom_blank` defaults.

All other functions wrap this function with a locked-in geom, and their own default `stat` and `position` arguments as per the applicable `geom_*` function.

```{r}
penguins |>
  drop_na(sex) |>
  mutate(across(sex, \(x) str_to_sentence(x))) |>
  gg_blanket(
    geom = "bar",
    stat = "bin",
    position = "stack",
    x = flipper_length_mm, 
    col = sex,
  ) 
```

```{r}
penguins |>
  drop_na(sex) |>
  mutate(across(sex, \(x) str_to_sentence(x))) |>
  gg_blanket(
    geom = "violin",
    stat = "ydensity",
    position = "dodge",
    x = species,
    y = body_mass_g,
    col = sex,
  )
```

## Further information 

See the ggblanket [website](https://davidhodge931.github.io/ggblanket/index.html) for further information, including [articles](https://davidhodge931.github.io/ggblanket/articles/) and [function reference](https://davidhodge931.github.io/ggblanket/reference/index.html).
