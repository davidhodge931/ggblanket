---
title: "ggblanket"
author: "David Hodge"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{ggblanket}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  warning = FALSE,
  fig.width = 6,
  fig.asp = 0.6,
  out.width = "70%",
  dpi = 300)
```

## Overview

ggblanket is a package of ggplot2 wrapper functions.

The primary objective is to **simplify ggplot2 visualisation**.

Secondary objectives relate to:

* Design: produce well-designed visualisation
* Alignment: align with ggplot2 and tidyverse
* Scope: cover much of what ggplot2 does.

Computational speed has been traded-off.

## How it works

1.  First setup with `set_blanket()`
2.  Each `gg_*` function wraps a geom
3.  A merged `col` argument to colour/fill by a variable
4.  A `facet` argument to facet by a variable
5.  A `facet2` argument to facet by a 2nd variable
6.  Smart `*_label` defaults for axis and legend titles
7.  Prefixed arguments to customise 
8.  Other `geom_*` arguments via `...`
9.  Families of `*_mode_*` themes with legend variants
10. Other aesthetics via `mapping`
11. A 'symmetric' continuous scale with easy opt-out
12. Ability to add multiple `geom_*` layers
13. A `gg_blanket()` function with `geom` flexibility
14. Arguments to customise setup with `set_blanket()`


```{r setup}
library(dplyr)
library(stringr)
library(ggplot2)
library(scales)
library(ggblanket)
library(palmerpenguins)
library(patchwork)

penguins2 <- penguins |> 
  labelled::set_variable_labels(
    bill_length_mm = "Bill length (mm)",
    bill_depth_mm = "Bill depth (mm)",
    flipper_length_mm = "Flipper length (mm)",
    body_mass_g = "Body mass (g)",
  ) |> 
  mutate(sex = factor(sex, labels = c("Female", "Male"))) |> 
  tidyr::drop_na(sex) 
```

### 1. First setup with `set_blanket()`

The `set_blanket()` function should be run first. 

This sets the default style of plots with themes and colours etc. It can be customised. 

But for now, just know that you need to run it at the start of every script or quarto document. 

```{r}
set_blanket()
```

### 2. Each `gg_*` function wraps a geom

Each `gg_*` function wraps a ggplot2 `ggplot2::ggplot()` function with the `gg_*` associated ggplot2 `geom_*()` function. 

Almost every geom in ggplot2 is wrapped. So there is almost 40 of them!

These functions can take each aesthetic as an argument. 

```{r}
penguins2 |>
  gg_point(
    x = flipper_length_mm,
    y = body_mass_g,
  )
```

### 3. A merged `col` argument to colour/fill by a variable

The colour and fill aesthetics of ggplot2 are merged into a single concept represented by the `col` argument. 

This combined aesthetic means that everything should be coloured according to it, i.e. all coloured outlines and filled interiors. 

Use `colour = NA` or `fill = NA` if you need to turn one of these off.

```{r}
penguins2 |>
  gg_point(
    x = flipper_length_mm,
    y = body_mass_g,
    col = species, 
  )
```

```{r, fig.asp=0.45}
penguins2 |>
  gg_bar(
    position = "dodge",
    y = species, 
    col = sex, 
    width = 0.75,
  )
```

### 4. A `facet` argument to facet by a variable

Faceting is treated as if it were an aesthetic. Users just provide an unquoted variable to facet by. 

When `facet` variable is _not_ NULL (and `facet2 = NULL`), the `facet_layout` will default to `"wrap"` (i.e. it will use `ggplot2::facet_wrap` under the hood).


```{r}
penguins2 |>
  gg_histogram(
    x = flipper_length_mm,
    facet = species,
  )
```

### 5. A `facet2` argument to facet by a 2nd variable

A `facet2` argument is also provided for extra functionality and flexibility. 

This enables users to facet easily in a `"grid"` layout of the `facet` variable horizontally by the `facet2` variable vertically. 

Whenever a `facet2` does _not_ equal NULL, the `facet_layout` will default to `"grid"` (i.e. it will use `ggplot2::facet_grid` under the hood).

```{r, fig.asp=0.75}
penguins2 |>
  gg_histogram(
    x = flipper_length_mm,
    facet = species,
    facet2 = sex,
  )
```

### 6.  Smart `*_label` defaults for axis and legend titles

The `x_label`, `y_label` and `col_label` for the axis and legend titles can be manually specified with the applicable `*_label` argument, or with `+ ggplot2::labs()`.

If not specified, they will first take any label attribute associated with the applicable variable. 

Otherwise, they will convert the variable name to a label name using the `label_to_case` function, which defaults to sentence case (i.e. `snakecase::to_sentence`). 

```{r, fig.asp=0.6}
penguins2 |>
  gg_freqpoly(
    x = flipper_length_mm,
    col = species,
  )
```

### 7.  Prefixed arguments to customise

ggblanket offers numerous arguments to customise that are prefixed by whether they relate to `x`, `y`, `col` or `facet`. 

These prefixed arguments can work nicely with auto-complete, if users ensure their settings support this.

All arguments prefixed `col_` relate to the merged colour/fill scale, and all prefixed `facet_` relates to _both_ `facet` and `facet2`.

```{r, echo = FALSE,   fig.width = 3, fig.asp = 2}
knitr::include_graphics("autocomplete_y.png", dpi = 300)
```

```{r}
penguins2 |>
  gg_jitter(
    x = species,
    y = body_mass_g,
    col = flipper_length_mm,
    facet = sex,
    x_labels = \(x) stringr::str_sub(x, 1, 1),
    y_breaks = breaks_width(1000),
    y_expand_limits = 2000,
    y_labels = label_number(big.mark = " "), 
    y_transform = "log10",
    col_steps = TRUE,
    col_breaks = \(x) quantile(x, seq(0, 1, 0.25)),
    col_palette = viridis::magma(n = 9, direction = -1),
  )
```

### 8. Other `geom_*` arguments via `...`

The `...` argument provides access to all other arguments in the `geom_*()` function. Common arguments to add include `colour`, `fill`, `alpha`, `linewidth`, `linetype`,  `size` and  `width`.

This is how you can turn off  _either_ colour or fill using `colour = NA`/`fill = NA` - or fix one to a single colour with `colour = "black"`/`fill = "lightgrey"` etc.

Use the `geom_*` help to see what arguments are available. 

```{r}
penguins2 |>
  gg_smooth(
    x = flipper_length_mm,
    y = body_mass_g,
    col = sex, 
    col_palette = c("#003f5c", "#ffa600"),
    colour = "#bc5090", 
    linewidth = 1, 
    linetype = "dashed",
    alpha = 1, 
    se = TRUE, 
    level = 0.999, 
  ) 
```

### 9.  Families of `*_mode_*` themes with legend variants 

Three families of complete themes are provided: `light_mode_*`, `grey_mode_*` and `dark_mode_*`.

Each mode family provides 4 variants that differ based on legend placement with suffix `r` (right), `b` (bottom), `t` (top) and `n` (none)). 

These are built for use with the `mode` argument in the `gg_*` functions, which has helpful side-effects for different orientations removing axis lines/ticks and gridlines.

If you want to use your own theme with no side-effects, just + the theme on to the plot.

Note:

* to remove a `*_label`, use `+ labs(... = NULL)` 
* for `col_label`, use `+ labs(colour = NULL, fill = NULL)` or `+ theme(legend.title = element_blank()`
* if you want a quick non-bold title, use `subtitle = "\n..."`.

```{r, fig.asp=0.65}
penguins2 |>
  gg_histogram(
    x = flipper_length_mm,
    col = species,
    title = "Penguin flipper length by species",
    subtitle = "Palmer Archipelago, Antarctica",
    caption = "Source: Gorman, 2020", 
    mode = dark_mode_t(),
  ) +
  theme(legend.title = element_blank())
```

### 11. Other aesthetics via `mapping`

The `mapping` argument provides access to other aesthetics, such as `alpha`, `size`, `shape`, `linetype` and `linewidth` etc. 

There is not prefixed arguments available for these aesthetics. Instead, you will need to + on any changes you need with ggplot2 layers.

Note, in some situations, the `alpha`, `size`, `shape`, `linetype` and `linewidth` values may need to be reversed in the relevant scale.

```{r}
penguins2 |> 
  gg_jitter(
    y = species, 
    x = flipper_length_mm, 
    col = species,
    mapping = aes(shape = species),
  ) +
  scale_shape_manual(values = rev(shape_pal()(3)))
```

### 11. A 'symmetric' continuous scale with easy opt-out

The `gg_*` function will generally create a 'symmetric' continuous y scale by default with: 

* `y_limits` that are the range of the `y_breaks` 
* `y_expand` of `c(0, 0)`.

However, for the plots guessed to be of horizontal orientation, the vice-versa will occurs with a 'symmetric' continuous x scale by default.

The key thing to know is that you can easily turn this 'symmetric' scale off using `*_limits = c(NA, NA)` (or `*_limits = c(0, NA)` for bars etc).

Note this symmetric scale does not occur where the scale has an unsusual  `*_transform` - or where the other positional scale is binned. Also, sometimes you may need to add `*_expand_limits = 0`, if the lower bound is close to 0.

```{r, echo=FALSE}
p1 <- penguins2 |>
  gg_pointrange(
    x = sex,
    y = flipper_length_mm,
    stat = "summary",
    position = position_dodge(),
    x_labels = \(x) str_sub(x, 1, 1),
    subtitle = "\nDefault y_limits",
    mode = light_mode_r(panel_grid_colour = "black")
  ) 

p2 <- penguins2 |>
  gg_pointrange(
    x = sex,
    y = flipper_length_mm,
    stat = "summary",
    position = position_dodge(),
    x_labels = \(x) str_sub(x, 1, 1),
    y_limits = c(NA, NA),
    subtitle = "\ny_limits = c(NA, NA),",
    mode = light_mode_r(panel_grid_colour = "black")
  ) 

p3 <- penguins2 |>
  gg_col(
    x = sex,
    y = flipper_length_mm,
    stat = "summary",
    position = position_dodge(),
    width = 0.5,
    x_labels = \(x) str_sub(x, 1, 1),
    y_limits = c(0, NA),
    subtitle = "\ny_limits = c(0, NA),",
    mode = light_mode_r(panel_grid_colour = "black")
  ) 

p1 + p2 + p3
```

### 12. Ability to add multiple `geom_*` layers

Users can make plots with multiple layers by `+`-ing on `ggplot2::geom_*` layers. 

The `gg_*` function puts the aesthetic variables within the wrapped `ggplot` function. Therefore, these aesthetics will inherit to any subsequent layers added. 

Generally, it works best to add all aesthetics required for the plot to the `gg_*` function, including the `col` argument. 

The `gg_*()` function should be appropriate to be the bottom layer of the plot, as geoms are drawn in order. 

For these reasons, you may sometimes need to use `gg_blanket()` as your `gg_*` function, as it defaults to a `blank` geom.

```{r, fig.asp = 0.4}
penguins2 |>
  group_by(species) |>
  summarise(
    lower = quantile(body_mass_g, probs = 0.05),
    upper = quantile(body_mass_g, probs = 0.95),
    body_mass_g = mean(body_mass_g, na.rm = TRUE),
  ) |>
  labelled::copy_labels_from(penguins2) |> 
  gg_blanket(
    x = body_mass_g,
    xmin = lower, 
    xmax = upper,
    y = species,
    col = species,
    x_expand_limits = 0,
  ) +
  geom_col(
    colour = "#d3d3d3",
    fill = "#d3d3d3",
    width = 0.75,
  ) +
  geom_errorbar(
    width = 0.1, 
  ) 
```

### 13. A `gg_blanket()` function with `geom` flexibility

ggblanket is driven by the `gg_blanket` function, which has a `geom` argument with `geom_blank` defaults.

All other functions wrap this function with a locked-in geom, and their own default `stat` and `position` arguments as per the applicable `geom_*` function.

You can print a `geom_*` function to identify the applicable `stat` and `position` arguments etc. 

```{r}
geom_histogram()

penguins2 |>
  gg_blanket(
    geom = "bar",
    stat = "bin",
    position = "stack",
    x = flipper_length_mm, 
    col = species,
  ) 
```

### 14. Arguments to customise setup with `set_blanket()`

The `set_blanket` function sets customisable defaults for the:

* mode (i.e. a theme with side-effects)
* geom colour (i.e. colour/fill where `col = NULL`)
* annotation colour  (i.e. colour/fill where `col = NULL` for geoms often used for annotation)
* discrete colour palette (and NA colour)
* continuous colour palette (and NA colour)
* theme (i.e. a theme added with no side-effects)

The `ggplot2::update_geom_defaults()` function can be used to further fine-tune geom defaults. 

Note `set_blanket()` also works on ggplot2 code. 

```{r}
set_blanket(
  mode = dark_mode_r(), 
  geom_colour = "#bc5090",
  annotate_colour = darkness[1],
  col_palette_d = c(purple, "tan", pink),
)

p1 <- penguins2 |>
  gg_point(
    x = flipper_length_mm, 
    y = body_mass_g,
    x_breaks = breaks_extended(3, only.loose = TRUE),
  ) +
  geom_vline(xintercept = 200) +
  annotate("text", x = I(0.25), y = I(0.75), label = "Here")

p2 <- penguins2 |> 
  gg_histogram(
    x = flipper_length_mm,
    col = species,
    x_breaks = breaks_extended(3, only.loose = TRUE),
  ) +
  geom_vline(xintercept = 200) +
  annotate("text", x = I(0.75), y = I(0.75), label = "Here")

p1 + p2
```

## Further information 

See the ggblanket [website](https://davidhodge931.github.io/ggblanket/index.html) for further information, including [articles](https://davidhodge931.github.io/ggblanket/articles/) and [function reference](https://davidhodge931.github.io/ggblanket/reference/index.html).
